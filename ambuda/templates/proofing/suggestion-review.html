{% extends 'header-main-footer.html' %}
{% import "macros/components.html" as mc %}


{% block title %}Review suggestion: {{ project.display_title }}/{{ page.slug }} | Ambuda{% endblock %}

<style>
  [x-cloak] { display: none !important; }
</style>

{% block header %}{% endblock %}
{% block footer %}{% endblock %}
{% block main %}

<div {% if suggestion.status == 'pending' %}x-data="suggestionReview()"{% endif %} class="h-screen flex flex-col overflow-hidden">

  {# Top bar #}
  <div class="flex-shrink-0 bg-slate-300 border-b text-sky-900 text-sm">
    <div class="flex items-center justify-between p-2 gap-4">

      {# Left: back link + suggestion info #}
      <div class="flex items-center gap-4">
        <a href="{{ url_for('proofing.suggestions.index') }}"
           class="p-2 rounded hover:bg-slate-400">&larr; {{ _('Suggestions') }}</a>
        <div>
          <a class="font-bold hover:underline"
             href="{{ url_for('proofing.project.summary', slug=project.slug) }}">{{ project.display_title }}</a>
          /
          <a class="hover:underline"
             href="{{ url_for('proofing.page.edit', project_slug=project.slug, page_slug=page.slug) }}">{{ page.slug }}</a>
        </div>
        <div class="text-slate-600 text-xs">
          {% if suggestion.user %}
          {{ _('By') }} {{ suggestion.user.username }}
          {% else %}
          {{ _('By Anonymous') }}
          {% endif %}
          &middot; {{ suggestion.created_at.strftime("%Y-%m-%d %H:%M") }}
        </div>
        {% if suggestion.explanation %}
        <div class="text-slate-600 text-xs italic">{{ suggestion.explanation }}</div>
        {% endif %}
        {% if is_stale and suggestion.status == 'pending' %}
        <span class="px-2 py-0.5 bg-yellow-200 text-yellow-800 text-xs rounded">{{ _('Stale') }}</span>
        {% endif %}
      </div>

      {# Right: actions #}
      <div class="flex items-center gap-2">
        {% if suggestion.status == 'pending' %}
        <button type="button"
                @click="submitReview()"
                :disabled="isStale || submitting"
                class="px-3 py-1.5 bg-green-600 text-white text-sm rounded hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed"
                {% if is_stale %}title="{{ _('This suggestion is based on an outdated revision') }}"{% endif %}>
          <span x-show="!submitting">{{ _('Submit') }}</span>
          <span x-show="submitting" x-cloak>{{ _('Submitting...') }}</span>
        </button>
        <form method="POST" action="{{ url_for('proofing.suggestions.reject', id=suggestion.id) }}">
          <button type="submit" class="px-3 py-1.5 bg-red-600 text-white text-sm rounded hover:bg-red-700">
            {{ _('Reject') }}
          </button>
        </form>
        {% else %}
        <span class="text-sm {% if suggestion.status == 'accepted' %}text-green-700{% else %}text-red-700{% endif %}">
          {{ suggestion.status|capitalize }}
        </span>
        {% endif %}
      </div>
    </div>
  </div>

  {% if is_stale and suggestion.status == 'pending' %}
  <div class="px-4 py-2 bg-yellow-100 border-b text-yellow-800 text-sm">
    {{ _('This suggestion is based on an outdated revision. The page has been edited since this suggestion was made. Please review carefully before accepting.') }}
  </div>
  {% endif %}

  {# Two-panel layout: diff on left, image on right #}
  <div class="flex flex-1 min-h-0">
    {# Left panel: diff #}
    <div class="flex-1 flex flex-col min-h-0 border-r border-slate-300">
      <div class="px-3 py-2 bg-slate-100 border-b text-xs font-semibold text-slate-600">{{ _('Changes') }}</div>
      <div class="flex-1 overflow-y-auto p-4">
        {% if suggestion.status == 'pending' %}
        {# Interactive diff with dismiss/undo controls #}
        <pre class="text-sm font-mono whitespace-pre-wrap leading-relaxed"><template
          x-for="(op, i) in ops" :key="i"><span><span
            x-show="op.op === 'equal'" x-text="op.new"></span><span
            x-show="op.op !== 'equal' && !dismissed[i]"><span class="relative inline group"><span
              x-show="op.op === 'delete' || op.op === 'replace'"><del class="bg-red-100 text-red-800" x-text="trimEnd(op.old)[0]"></del></span><span
              x-show="op.op === 'insert' || op.op === 'replace'"><ins class="bg-green-100 text-green-800 no-underline" x-text="trimEnd(op.new)[0]"></ins></span><button
              type="button"
              @click="dismiss(i)"
              class="absolute -top-1 -right-2 hidden group-hover:inline-flex items-center justify-center w-4 h-4 bg-slate-600 text-white rounded-full text-xs leading-none cursor-pointer"
              title="{{ _('Dismiss this change') }}">&times;</button></span><span x-text="op.op === 'insert' ? trimEnd(op.new)[1] : trimEnd(op.old)[1]"></span></span><span
            x-show="op.op !== 'equal' && dismissed[i]"><span class="relative inline group"><span class="bg-slate-100 text-slate-400" x-text="trimEnd(op.old)[0]"></span><button
              type="button"
              @click="restore(i)"
              class="absolute -top-1 -right-2 hidden group-hover:inline-flex items-center justify-center w-4 h-4 bg-blue-600 text-white rounded-full text-xs leading-none cursor-pointer"
              title="{{ _('Restore this change') }}">&#x21a9;</button></span><span x-text="trimEnd(op.old)[1]"></span></span></span></template></pre>
        {% else %}
        {# Read-only diff #}
        <pre class="text-sm font-mono whitespace-pre-wrap leading-relaxed">{{ diff|safe }}</pre>
        {% endif %}
      </div>
    </div>

    {# Right panel: page image #}
    <div class="flex-1 flex flex-col min-h-0">
      <div class="px-3 py-2 bg-slate-100 border-b text-xs font-semibold text-slate-600 flex items-center justify-between">
        <span>{{ _('Page image') }}</span>
        <div class="flex items-center gap-1" x-data>
          <button type="button" class="p-1 hover:bg-slate-200 rounded" id="osd-zoom-in" title="{{ _('Zoom in') }}">&#x1f50d;<sup>+</sup></button>
          <button type="button" class="p-1 hover:bg-slate-200 rounded" id="osd-zoom-out" title="{{ _('Zoom out') }}">&#x1f50d;<sup>-</sup></button>
          <button type="button" class="p-1 hover:bg-slate-200 rounded" id="osd-home" title="{{ _('Reset') }}">&#x1f50d;&#x00b0;</button>
        </div>
      </div>
      <div id="osd-image" class="flex-1 min-h-0 bg-slate-100"></div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/openseadragon@3.1/build/openseadragon/openseadragon.min.js"></script>
<script type="text/javascript">
{% if suggestion.status == 'pending' %}
function suggestionReview() {
  return {
    ops: {{ diff_ops_json|safe }},
    dismissed: {},
    isStale: {{ 'true' if is_stale else 'false' }},
    submitting: false,

    trimEnd(s) {
      const m = s.match(/^([\s\S]*?)(\s*)$/);
      return [m[1], m[2]];
    },

    dismiss(i) {
      this.dismissed[i] = true;
    },

    restore(i) {
      delete this.dismissed[i];
    },

    reconstructContent() {
      return this.ops.map((op, i) => this.dismissed[i] ? op.old : op.new).join('');
    },

    async submitReview() {
      if (this.isStale || this.submitting) return;
      this.submitting = true;
      try {
        const resp = await fetch("{{ url_for('proofing.suggestions.submit_review', id=suggestion.id) }}", {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({content: this.reconstructContent()}),
        });
        const data = await resp.json();
        if (data.ok) {
          window.location.href = data.redirect;
        } else {
          alert(data.error || 'An error occurred.');
          this.submitting = false;
        }
      } catch (e) {
        alert('Network error.');
        this.submitting = false;
      }
    },
  };
}
{% endif %}

document.addEventListener('DOMContentLoaded', function() {
  const viewer = OpenSeadragon({
    id: 'osd-image',
    prefixUrl: 'https://cdn.jsdelivr.net/npm/openseadragon@3.1/build/openseadragon/images/',
    tileSources: {
      type: 'image',
      url: '{{ image_url }}',
    },
    showNavigationControl: false,
    gestureSettingsMouse: { scrollToZoom: true },
  });

  document.getElementById('osd-zoom-in').addEventListener('click', function() {
    viewer.viewport.zoomBy(1.5);
  });
  document.getElementById('osd-zoom-out').addEventListener('click', function() {
    viewer.viewport.zoomBy(0.67);
  });
  document.getElementById('osd-home').addEventListener('click', function() {
    viewer.viewport.goHome();
  });
});
</script>
{% endblock %}
