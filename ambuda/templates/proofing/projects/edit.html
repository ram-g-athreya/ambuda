{% extends 'proofing/base-sidebar.html' %}
{% import "macros/components.html" as components %}
{% import "macros/forms.html" as mf %}
{% import "macros/proofing.html" as m %}


{% block title %}Edit: {{ project.display_title }} | Ambuda{% endblock %}


{% block sidebar %}{{ m.main_nav('projects', current_user=current_user) }}{% endblock %}


{% block content %}
{{ m.project_header_nested('Edit', project) }}
{{ m.project_tabs(project=project, active='edit', is_mod=current_user.is_moderator) }}

{% set ocr_url = url_for("proofing.project.batch_ocr", slug=project.slug)  %}
{% set editing_url = url_for("proofing.project.batch_editing", slug=project.slug)  %}
{% set batch_llm_url = url_for("proofing.project.batch_llm", slug=project.slug)  %}

<div class="prose">

<ul>
  <li><a href="{{ ocr_url }}">{{ _('Run batch OCR') }}</a></li>
  <li><a href="{{ editing_url }}">{{ _('Run batch editing') }}</a></li>
  {% if current_user.is_p2 %}
  <li><a href="{{ batch_llm_url }}">{{ _('Run batch LLM') }}</a></li>
  {% endif %}
</ul>

{{ components.flash_messages() }}
{{ mf.show_errors_if_any(form.errors) }}

<form method="POST">
  {{ form.csrf_token }}

  <fieldset>
    <legend class="text-lg font-bold mt-8 mb-4">Basic information</legend>
    <div class="bg-slate-100 rounded p-4">
      <div class="grid grid-cols-[8rem_1fr] gap-x-4 gap-y-3 text-sm items-center">
        {{ form.display_title.label(class_="text-slate-500") }}
        {{ form.display_title(class_="p-2 w-full rounded border border-slate-300") }}

        {{ form.slug.label(class_="text-slate-500") }}
        <div class="flex gap-2">
          {{ form.slug(class_="p-2 w-full rounded border border-slate-300 flex-1", id="slug-field") }}
          <button type="button" class="btn btn-secondary whitespace-nowrap" onclick="regenerateSlug()">{{ _('Regenerate') }}</button>
        </div>

        {% if current_user.is_p2 %}
        {{ form.status.label(class_="text-slate-500") }}
        {{ form.status(class_="p-2 w-full rounded border border-slate-300") }}
        {% endif %}

        {{ form.genre.label(class_="text-slate-500") }}
        {{ form.genre(class_="p-2 w-full rounded border border-slate-300") }}

        <div class="col-span-2 mt-2">
          {{ form.description.label(class_="text-slate-500 mb-1 block") }}
          {{ form.description(class_="border border-slate-300 p-2 w-full min-h-[200px] rounded") }}
          {% set help_url = "https://commonmark.org/help/" %}
          <p class="text-slate-500 mt-1 a-underline">{% trans %}
            You can format this text with Markdown.
            <a href="{{ help_url }}">Click here to learn more.</a>
          {% endtrans %}</p>
        </div>

        <div class="col-span-2">
          {{ form.page_numbers.label(class_="text-slate-500 mb-1 block") }}
          {{ form.page_numbers(class_="border border-slate-300 p-2 w-full rounded") }}
        </div>
      </div>
    </div>
  </fieldset>

  <fieldset>
    <legend class="text-lg font-bold mt-8 mb-4">Book metadata</legend>
    <div class="bg-slate-100 rounded p-4">
      <div class="grid grid-cols-[8rem_1fr] gap-x-4 gap-y-3 text-sm items-center">
        {{ form.print_title.label(class_="text-slate-500") }}
        {{ form.print_title(class_="p-2 w-full rounded border border-slate-300") }}

        {{ form.author.label(class_="text-slate-500") }}
        {{ form.author(class_="p-2 w-full rounded border border-slate-300") }}

        {{ form.editor.label(class_="text-slate-500") }}
        {{ form.editor(class_="p-2 w-full rounded border border-slate-300") }}

        {{ form.publisher.label(class_="text-slate-500") }}
        {{ form.publisher(class_="p-2 w-full rounded border border-slate-300") }}

        {{ form.publication_year.label(class_="text-slate-500") }}
        {{ form.publication_year(class_="p-2 w-full rounded border border-slate-300") }}

        {{ form.worldcat_link.label(class_="text-slate-500") }}
        {{ form.worldcat_link(class_="p-2 w-full rounded border border-slate-300") }}
      </div>
    </div>
  </fieldset>

  <fieldset>
    <legend class="text-lg font-bold mt-8 mb-4">Internal notes</legend>
    <div class="bg-slate-100 rounded p-4 text-sm">
      {{ form.notes.label(class_="text-slate-500 mb-1 block") }}
      {{ form.notes(class_="border border-slate-300 p-2 w-full rounded") }}
    </div>
  </fieldset>

  <input class="btn btn-submit mt-4" type="submit" value="{{ _('Save changes') }}">
</form>

<script>
function regenerateSlug() {
  const titleField = document.getElementById('display_title');
  const slugField = document.getElementById('slug-field');

  if (!titleField || !slugField) return;

  const title = titleField.value;

  // Generate slug: strip, lowercase, replace whitespace/special chars with hyphens
  let slug = title
    .trim()
    .toLowerCase()
    // Replace any sequence of whitespace with a single hyphen
    .replace(/\s+/g, '-')
    // Remove diacritics and special characters (keep only alphanumeric and hyphens)
    .normalize('NFD')
    .replace(/[\u0300-\u036f]/g, '')
    // Replace any non-alphanumeric characters (except hyphens) with hyphens
    .replace(/[^a-z0-9-]/g, '-')
    // Replace multiple consecutive hyphens with a single hyphen
    .replace(/-+/g, '-')
    // Remove leading/trailing hyphens
    .replace(/^-+|-+$/g, '');

  slugField.value = slug;
}
</script>

{% endblock %}
