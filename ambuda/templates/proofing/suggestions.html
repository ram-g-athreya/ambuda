{% extends 'proofing/base.html' %}
{% import "macros/proofing.html" as m %}
{% import "macros/components.html" as mc %}


{% block title %}Suggestions | Ambuda{% endblock %}


{% block content %}

{{ m.proofing_tabs('suggestions', current_user) }}

<h1 class="text-2xl font-bold mb-4">{{ _('Suggestions') }}</h1>

<div class="flex gap-2 mb-6">
  <a href="{{ url_for('proofing.suggestions.index', status='pending') }}"
     class="px-3 py-1 rounded text-sm {% if status_filter == 'pending' %}bg-sky-900 text-white{% else %}bg-slate-200 text-slate-700 hover:bg-slate-300{% endif %}">
    {{ _('Pending') }}
  </a>
  <a href="{{ url_for('proofing.suggestions.index', status='accepted') }}"
     class="px-3 py-1 rounded text-sm {% if status_filter == 'accepted' %}bg-green-700 text-white{% else %}bg-slate-200 text-slate-700 hover:bg-slate-300{% endif %}">
    {{ _('Accepted') }}
  </a>
  <a href="{{ url_for('proofing.suggestions.index', status='rejected') }}"
     class="px-3 py-1 rounded text-sm {% if status_filter == 'rejected' %}bg-red-700 text-white{% else %}bg-slate-200 text-slate-700 hover:bg-slate-300{% endif %}">
    {{ _('Rejected') }}
  </a>
</div>

{{ mc.flash_messages() }}

{% if not suggestions %}
<p class="text-slate-500">{{ _('No suggestions found.') }}</p>
{% else %}
<div class="space-y-4">
  {% for s in suggestions %}
  <div class="border rounded p-4 {% if s._is_stale and s.status == 'pending' %}border-yellow-400 bg-yellow-50{% else %}bg-white{% endif %}">
    <div class="flex justify-between items-start mb-2">
      <div>
        <a class="font-semibold text-sky-900 hover:underline"
           href="{{ url_for('proofing.project.summary', slug=s.project.slug) }}">{{ s.project.display_title }}</a>
        /
        <a class="text-sky-900 hover:underline"
           href="{{ url_for('proofing.page.edit', project_slug=s.project.slug, page_slug=s.page.slug) }}">{{ s.page.slug }}</a>
        {% if s._is_stale and s.status == 'pending' %}
        <span class="ml-2 px-2 py-0.5 bg-yellow-200 text-yellow-800 text-xs rounded">{{ _('Stale') }}</span>
        {% endif %}
      </div>
      <div class="text-sm text-slate-500">
        {{ s.created_at.strftime("%Y-%m-%d %H:%M") }}
      </div>
    </div>

    <div class="text-sm text-slate-600 mb-2">
      {% if s.user %}
      {{ _('By') }} <a class="hover:underline" href="{{ url_for('user.summary', username=s.user.username) }}">{{ s.user.username }}</a>
      {% else %}
      {{ _('By Anonymous') }}
      {% endif %}
      {% if s.explanation %}
      &mdash; <i>{{ s.explanation }}</i>
      {% endif %}
    </div>

    <details class="mb-3">
      <summary class="text-sm text-slate-500 cursor-pointer hover:text-slate-700">{{ _('Show changes') }}</summary>
      <pre class="mt-2 p-2 bg-slate-50 border rounded text-xs max-h-48 overflow-y-auto font-mono whitespace-pre-wrap">{{ s._diff|safe }}</pre>
    </details>

    {% if s.status == 'pending' %}
    <div class="flex gap-2">
      <form method="POST" action="{{ url_for('proofing.suggestions.accept', id=s.id) }}">
        <button type="submit" class="px-3 py-1 bg-green-600 text-white text-sm rounded hover:bg-green-700"
                {% if s._is_stale %}title="{{ _('This suggestion is based on an outdated revision') }}"{% endif %}>
          {{ _('Accept') }}
        </button>
      </form>
      <form method="POST" action="{{ url_for('proofing.suggestions.reject', id=s.id) }}">
        <button type="submit" class="px-3 py-1 bg-red-600 text-white text-sm rounded hover:bg-red-700">
          {{ _('Reject') }}
        </button>
      </form>
    </div>
    {% else %}
    <span class="text-sm {% if s.status == 'accepted' %}text-green-700{% else %}text-red-700{% endif %}">
      {{ s.status|capitalize }}
    </span>
    {% endif %}
  </div>
  {% endfor %}
</div>

{% if next_cursor %}
<div class="mt-6">
  <a href="{{ url_for('proofing.suggestions.index', status=status_filter, before=next_cursor) }}"
     class="px-4 py-2 bg-slate-200 text-slate-700 rounded hover:bg-slate-300 text-sm">
    {{ _('Older suggestions') }} &rarr;
  </a>
</div>
{% endif %}
{% endif %}

{% endblock %}
